<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞—è–≤–∫–∏ –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</title>
    <style>
/* ============================================================
   –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò
   ============================================================ */

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
    min-height: 100vh;
    color: #ffffff;
}

/* ============================================================
   –≠–ö–†–ê–ù –í–•–û–î–ê
   ============================================================ */

.login-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 20px;
}

.login-box {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 40px;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.login-box h1 {
    text-align: center;
    margin-bottom: 10px;
    font-size: 24px;
    background: linear-gradient(90deg, #00d4ff, #00ff88);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.login-box h2 {
    text-align: center;
    margin-bottom: 30px;
    font-size: 14px;
    color: #aaa;
    font-weight: normal;
}

.login-box input {
    width: 100%;
    padding: 15px;
    margin-bottom: 20px;
    border: none;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    font-size: 16px;
    transition: all 0.3s ease;
}

.login-box input:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.2);
    box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
}

.login-box input::placeholder {
    color: #888;
}

.login-box button {
    width: 100%;
    padding: 15px;
    border: none;
    border-radius: 10px;
    background: linear-gradient(90deg, #00d4ff, #00ff88);
    color: #1a1a2e;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

.login-box button:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
}

.error-message {
    color: #ff6b6b;
    text-align: center;
    margin-top: 15px;
    font-size: 14px;
}

/* ============================================================
   –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ô–ù–ï–†
   ============================================================ */

.main-container {
    display: none;
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 15px;
}

.header h1 {
    font-size: 24px;
    background: linear-gradient(90deg, #00d4ff, #00ff88);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
}

.user-info span {
    color: #aaa;
    font-size: 14px;
}

.user-info .department {
    background: rgba(0, 212, 255, 0.2);
    padding: 5px 15px;
    border-radius: 20px;
    color: #00d4ff;
    font-weight: bold;
}

.header-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

/* ============================================================
   –ö–ù–û–ü–ö–ò
   ============================================================ */

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-primary {
    background: linear-gradient(90deg, #00d4ff, #00ff88);
    color: #1a1a2e;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
}

.btn-secondary {
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-secondary:hover {
    background: rgba(255, 255, 255, 0.2);
}

.btn-danger {
    background: rgba(255, 107, 107, 0.2);
    color: #ff6b6b;
    border: 1px solid rgba(255, 107, 107, 0.3);
}

.btn-danger:hover {
    background: rgba(255, 107, 107, 0.3);
}

.btn-success {
    background: rgba(0, 255, 136, 0.2);
    color: #00ff88;
    border: 1px solid rgba(0, 255, 136, 0.3);
}

.btn-success:hover {
    background: rgba(0, 255, 136, 0.3);
}

.btn-small {
    padding: 5px 10px;
    font-size: 12px;
}

/* ============================================================
   –§–û–†–ú–ê –ó–ê–Ø–í–ö–ò
   ============================================================ */

.order-form {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.form-header {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group label {
    color: #aaa;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.form-group input,
.form-group select {
    padding: 12px 15px;
    border: none;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    font-size: 14px;
    transition: all 0.3s ease;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.15);
    box-shadow: 0 0 15px rgba(0, 212, 255, 0.2);
}

.form-group select option {
    background: #1a1a2e;
    color: #fff;
}

.form-group input:disabled,
.form-group select:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* ============================================================
   –¢–ê–ë–õ–ò–¶–ê –ü–û–ó–ò–¶–ò–ô
   ============================================================ */

.positions-section h3 {
    margin-bottom: 15px;
    color: #00d4ff;
    font-size: 16px;
}

.positions-table-container {
    overflow-x: auto;
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.positions-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px;
}

.positions-table th {
    background: rgba(0, 212, 255, 0.1);
    padding: 12px 10px;
    text-align: left;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #00d4ff;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.positions-table td {
    padding: 8px 10px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.positions-table tr:hover {
    background: rgba(255, 255, 255, 0.02);
}

.positions-table input,
.positions-table select {
    width: 100%;
    padding: 8px 10px;
    border: none;
    border-radius: 5px;
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    font-size: 13px;
}

.positions-table input:focus,
.positions-table select:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.15);
}

.positions-table .col-num { width: 50px; text-align: center; }
.positions-table .col-name { min-width: 200px; }
.positions-table .col-unit { width: 100px; }
.positions-table .col-qty { width: 80px; }
.positions-table .col-article { width: 120px; }
.positions-table .col-note { min-width: 150px; }
.positions-table .col-status { width: 70px; text-align: center; }
.positions-table .col-action { width: 50px; text-align: center; }

/* ============================================================
   –ö–ù–û–ü–ö–ò –°–¢–ê–¢–£–°–ê
   ============================================================ */

.status-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
}

.status-btn.not-completed {
    background: rgba(255, 107, 107, 0.3);
    color: #ff6b6b;
    box-shadow: 0 0 10px rgba(255, 107, 107, 0.3);
}

.status-btn.completed {
    background: rgba(0, 255, 136, 0.3);
    color: #00ff88;
    box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
}

.status-btn:hover {
    transform: scale(1.1);
}

.status-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.delete-row-btn {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    border: none;
    background: rgba(255, 107, 107, 0.2);
    color: #ff6b6b;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 18px;
}

.delete-row-btn:hover {
    background: rgba(255, 107, 107, 0.4);
    transform: scale(1.1);
}
/* ============================================================
   –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô –§–û–†–ú–´
   ============================================================ */

.form-actions {
    display: flex;
    gap: 15px;
    margin-top: 20px;
    flex-wrap: wrap;
}

.add-row-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: rgba(0, 212, 255, 0.1);
    border: 1px dashed rgba(0, 212, 255, 0.3);
    border-radius: 10px;
    color: #00d4ff;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
}

.add-row-btn:hover {
    background: rgba(0, 212, 255, 0.2);
    border-style: solid;
}

/* ============================================================
   –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê
   ============================================================ */

.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.modal-overlay.active {
    display: flex;
}

.modal {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border-radius: 20px;
    width: 100%;
    max-width: 1200px;
    max-height: 90vh;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 30px;
    background: rgba(0, 212, 255, 0.1);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.modal-header h2 {
    color: #00d4ff;
    font-size: 18px;
}

.modal-close {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: none;
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    cursor: pointer;
    font-size: 20px;
    transition: all 0.3s ease;
}

.modal-close:hover {
    background: rgba(255, 107, 107, 0.3);
    color: #ff6b6b;
}

.modal-body {
    padding: 30px;
    overflow-y: auto;
    max-height: calc(90vh - 140px);
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 20px 30px;
    background: rgba(0, 0, 0, 0.2);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

/* ============================================================
   –ò–°–¢–û–†–ò–Ø –ó–ê–Ø–í–û–ö
   ============================================================ */

.history-filters {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.history-filters .form-group {
    min-width: 150px;
}

.history-table {
    width: 100%;
    border-collapse: collapse;
}

.history-table th {
    background: rgba(0, 212, 255, 0.1);
    padding: 12px 15px;
    text-align: left;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #00d4ff;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.history-table td {
    padding: 12px 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    font-size: 14px;
}

.history-table tr:hover {
    background: rgba(255, 255, 255, 0.05);
}

.history-table tr {
    cursor: pointer;
    transition: all 0.2s ease;
}

.status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
}

.status-badge.completed {
    background: rgba(0, 255, 136, 0.2);
    color: #00ff88;
}

.status-badge.partial {
    background: rgba(255, 193, 7, 0.2);
    color: #ffc107;
}

.status-badge.pending {
    background: rgba(255, 107, 107, 0.2);
    color: #ff6b6b;
}

/* ============================================================
   –î–ï–¢–ê–õ–ò –ó–ê–Ø–í–ö–ò
   ============================================================ */

.order-details-header {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
    padding: 20px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
}

.detail-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.detail-item label {
    color: #888;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.detail-item span {
    color: #fff;
    font-size: 14px;
    font-weight: 500;
}

/* ============================================================
   –ó–ê–ì–†–£–ó–ö–ê –ò –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
   ============================================================ */

.loading-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 2000;
    justify-content: center;
    align-items: center;
}

.loading-overlay.active {
    display: flex;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 4px solid rgba(255, 255, 255, 0.1);
    border-top-color: #00d4ff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.toast {
    position: fixed;
    bottom: 30px;
    right: 30px;
    padding: 15px 25px;
    border-radius: 10px;
    color: white;
    font-weight: 500;
    z-index: 3000;
    transform: translateX(150%);
    transition: transform 0.3s ease;
    max-width: 350px;
}

.toast.active {
    transform: translateX(0);
}

.toast.success {
    background: linear-gradient(135deg, #00ff88, #00d4ff);
    color: #1a1a2e;
}

.toast.error {
    background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
    color: #1a1a2e;
}

.toast.warning {
    background: linear-gradient(135deg, #ffc107, #ffdb4d);
    color: #1a1a2e;
}

/* ============================================================
   –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨
   ============================================================ */

@media (max-width: 768px) {
    .header {
        flex-direction: column;
        align-items: flex-start;
    }
    .header-buttons {
        width: 100%;
    }
    .header-buttons .btn {
        flex: 1;
        justify-content: center;
    }
    .form-header {
        grid-template-columns: 1fr;
    }
    .modal {
        margin: 10px;
        max-height: 95vh;
    }
    .modal-body {
        padding: 15px;
    }
    .history-filters {
        flex-direction: column;
    }
    .history-filters .form-group {
        width: 100%;
    }
}

@media print {
    body {
        background: white !important;
        color: black !important;
    }
    .login-container, .header, .form-actions, .modal-overlay, .btn,
    .delete-row-btn, .add-row-btn, .loading-overlay, .toast {
        display: none !important;
    }
    .main-container {
        display: block !important;
        padding: 0;
        max-width: none;
    }
    .order-form {
        background: white;
        border: none;
        padding: 0;
    }
}
    </style>
</head>
<body>

<!-- –ó–ê–ì–†–£–ó–ö–ê -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
</div>

<!-- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø -->
<div class="toast" id="toast"></div>

<!-- –≠–ö–†–ê–ù –í–•–û–î–ê -->
<div class="login-container" id="loginScreen">
    <div class="login-box">
        <h1>üì¶ –ó–∞—è–≤–∫–∏ –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</h1>
        <h2>–°–∏—Å—Ç–µ–º–∞ —É—á—ë—Ç–∞ –∑–∞—è–≤–æ–∫</h2>
        <input type="password" id="passwordInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" autocomplete="off">
        <button onclick="handleLogin()">–í–æ–π—Ç–∏</button>
        <div class="error-message" id="loginError"></div>
    </div>
</div>

<!-- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ô–ù–ï–† -->
<div class="main-container" id="mainScreen">
    
    <!-- –®–∞–ø–∫–∞ -->
    <div class="header">
        <h1>üì¶ –ó–∞—è–≤–∫–∏ –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</h1>
        <div class="user-info">
            <span>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</span>
            <span class="department" id="userDepartment">-</span>
        </div>
        <div class="header-buttons">
            <button class="btn btn-secondary" onclick="openHistory()">üìã –ò—Å—Ç–æ—Ä–∏—è</button>
            <button class="btn btn-secondary" onclick="printOrder()">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
            <button class="btn btn-danger" onclick="handleLogout()">üö™ –í—ã—Ö–æ–¥</button>
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ –∑–∞—è–≤–∫–∏ -->
    <div class="order-form" id="orderForm">
        
        <!-- –®–∞–ø–∫–∞ —Ñ–æ—Ä–º—ã -->
        <div class="form-header">
            <div class="form-group">
                <label>‚Ññ –∑–∞—è–≤–∫–∏</label>
                <input type="text" id="orderNumber" disabled placeholder="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏">
            </div>
            <div class="form-group">
                <label>–î–∞—Ç–∞</label>
                <input type="text" id="orderDate" disabled>
            </div>
            <div class="form-group">
                <label>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</label>
                <select id="orderDepartment" disabled>
                    <option value="">-</option>
                </select>
            </div>
            <div class="form-group">
                <label>–û–±—ä–µ–∫—Ç (–¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤)</label>
                <input type="text" id="orderObject" maxlength="20" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–±—ä–µ–∫—Ç">
            </div>
            <div class="form-group">
                <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select id="orderCategory">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                </select>
            </div>
            <div class="form-group">
                <label>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</label>
                <select id="orderResponsible">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                </select>
            </div>
            <div class="form-group">
                <label>–°–æ–∑–¥–∞–ª –∑–∞—è–≤–∫—É</label>
                <select id="orderCreatedBy">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                </select>
            </div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–∑–∏—Ü–∏–π -->
        <div class="positions-section">
            <h3>–ü–æ–∑–∏—Ü–∏–∏ –∑–∞—è–≤–∫–∏ (–º–∞–∫—Å–∏–º—É–º 15)</h3>
            <div class="positions-table-container">
                <table class="positions-table" id="positionsTable">
                    <thead>
                        <tr>
                            <th class="col-num">‚Ññ</th>
                            <th class="col-name">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞</th>
                            <th class="col-unit">–ï–¥. –∏–∑–º.</th>
                            <th class="col-qty">–ö–æ–ª-–≤–æ</th>
                            <th class="col-article">–ê—Ä—Ç–∏–∫—É–ª/–ö–æ–¥</th>
                            <th class="col-note">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
                            <th class="col-action"></th>
                        </tr>
                    </thead>
                    <tbody id="positionsBody"></tbody>
                </table>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="form-actions">
            <button class="add-row-btn" onclick="addPositionRow()">
                <span>‚ûï</span> –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é
            </button>
            <div style="flex-grow: 1;"></div>
            <button class="btn btn-secondary" onclick="clearForm()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
            <button class="btn btn-primary" onclick="saveOrder()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞—è–≤–∫—É</button>
        </div>
    </div>
</div>
<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û: –ò–°–¢–û–†–ò–Ø –ó–ê–Ø–í–û–ö -->
<div class="modal-overlay" id="historyModal">
    <div class="modal">
        <div class="modal-header">
            <h2>üìã –ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫</h2>
            <button class="modal-close" onclick="closeHistory()">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="history-filters">
                <div class="form-group">
                    <label>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</label>
                    <select id="filterDepartment" onchange="loadHistory()">
                        <option value="">–í—Å–µ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–î–∞—Ç–∞</label>
                    <input type="date" id="filterDate" onchange="loadHistory()">
                </div>
                <div class="form-group" style="align-self: flex-end;">
                    <button class="btn btn-secondary" onclick="clearFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                </div>
            </div>
            
            <div class="positions-table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>‚Ññ –∑–∞—è–≤–∫–∏</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</th>
                            <th>–û–±—ä–µ–∫—Ç</th>
                            <th>–°–æ–∑–¥–∞–ª</th>
                            <th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>
            
            <div id="historyEmpty" style="text-align: center; padding: 40px; color: #888; display: none;">
                –ó–∞—è–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
            </div>
        </div>
    </div>
</div>

<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û: –î–ï–¢–ê–õ–ò –ó–ê–Ø–í–ö–ò -->
<div class="modal-overlay" id="orderDetailsModal">
    <div class="modal">
        <div class="modal-header">
            <h2>üìÑ –ó–∞—è–≤–∫–∞ <span id="detailsOrderNumber"></span></h2>
            <button class="modal-close" onclick="closeOrderDetails()">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="order-details-header">
                <div class="detail-item">
                    <label>‚Ññ –∑–∞—è–≤–∫–∏</label>
                    <span id="detailNumber">-</span>
                </div>
                <div class="detail-item">
                    <label>–î–∞—Ç–∞</label>
                    <span id="detailDate">-</span>
                </div>
                <div class="detail-item">
                    <label>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</label>
                    <span id="detailDepartment">-</span>
                </div>
                <div class="detail-item">
                    <label>–û–±—ä–µ–∫—Ç</label>
                    <span id="detailObject">-</span>
                </div>
                <div class="detail-item">
                    <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <span id="detailCategory">-</span>
                </div>
                <div class="detail-item">
                    <label>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</label>
                    <span id="detailResponsible">-</span>
                </div>
                <div class="detail-item">
                    <label>–°–æ–∑–¥–∞–ª –∑–∞—è–≤–∫—É</label>
                    <span id="detailCreatedBy">-</span>
                </div>
            </div>

            <div class="positions-table-container">
                <table class="positions-table">
                    <thead>
                        <tr>
                            <th class="col-num">‚Ññ</th>
                            <th class="col-name">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞</th>
                            <th class="col-unit">–ï–¥. –∏–∑–º.</th>
                            <th class="col-qty">–ö–æ–ª-–≤–æ</th>
                            <th class="col-article">–ê—Ä—Ç–∏–∫—É–ª/–ö–æ–¥</th>
                            <th class="col-note">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
                            <th class="col-status">–°—Ç–∞—Ç—É—Å</th>
                        </tr>
                    </thead>
                    <tbody id="detailsPositionsBody"></tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="printOrderDetails()">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
            <button class="btn btn-danger" id="deleteOrderBtn" onclick="deleteCurrentOrder()" style="display: none;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            <button class="btn btn-primary" onclick="closeOrderDetails()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<script>
// ============================================================
// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
// ============================================================

const API_URL = 'https://script.google.com/macros/s/AKfycbyQWKQ5nJaRHyS4GjZQac-v0pLF2T9vWR0YCJ3R6t0TsCIn8HQtkafUzuI4RjrCRKJf/exec';

// ============================================================
// –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
// ============================================================

let currentUser = { role: '', department: '', employees: [], password: '' };
let settings = { units: [], categories: [], departments: [] };
let currentOrderId = null;
let positionRowCount = 0;

// ============================================================
// –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
// ============================================================

function showLoading() {
    document.getElementById('loadingOverlay').classList.add('active');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('active');
}

function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast ' + type + ' active';
    setTimeout(() => toast.classList.remove('active'), 4000);
}

function formatDate(date) {
    const d = new Date(date);
    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const year = d.getFullYear();
    const hours = String(d.getHours()).padStart(2, '0');
    const minutes = String(d.getMinutes()).padStart(2, '0');
    return `${day}.${month}.${year} ${hours}:${minutes}`;
}

// ============================================================
// API –ó–ê–ü–†–û–°–´ (JSONP –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS)
// ============================================================

function apiRequest(params) {
    return new Promise((resolve) => {
        const callbackName = 'jsonp_cb_' + Date.now() + '_' + Math.floor(Math.random() * 100000);
        
        const url = new URL(API_URL);
        Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
        url.searchParams.append('callback', callbackName);
        
        window[callbackName] = (data) => {
            resolve(data);
            cleanup();
        };
        
        function cleanup() {
            try { delete window[callbackName]; } catch (e) { window[callbackName] = undefined; }
            if (script && script.parentNode) script.parentNode.removeChild(script);
        }
        
        const script = document.createElement('script');
        script.src = url.toString();
        script.onerror = () => {
            resolve({ success: false, error: '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º' });
            cleanup();
        };
        
        document.head.appendChild(script);
    });
}

// ============================================================
// –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
// ============================================================

async function handleLogin() {
    const password = document.getElementById('passwordInput').value.trim();
    const errorDiv = document.getElementById('loginError');
    
    if (!password) {
        errorDiv.textContent = '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å';
        return;
    }
    
    showLoading();
    errorDiv.textContent = '';
    
    const result = await apiRequest({ action: 'login', password: password });
    
    hideLoading();
    
    if (result.success) {
        currentUser = {
            role: result.role,
            department: result.department,
            employees: result.employees || [],
            password: password
        };
        sessionStorage.setItem('user', JSON.stringify(currentUser));
        await loadSettings();
        showMainScreen();
        showToast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', 'success');
    } else {
        errorDiv.textContent = result.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
    }
}

function handleLogout() {
    sessionStorage.removeItem('user');
    currentUser = { role: '', department: '', employees: [], password: '' };
    document.getElementById('mainScreen').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('passwordInput').value = '';
    document.getElementById('loginError').textContent = '';
    showToast('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'success');
}

async function checkSession() {
    const savedUser = sessionStorage.getItem('user');
    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showLoading();
        const result = await apiRequest({ action: 'login', password: currentUser.password });
        hideLoading();
        if (result.success) {
            currentUser.employees = result.employees || currentUser.employees;
            await loadSettings();
            showMainScreen();
        } else {
            sessionStorage.removeItem('user');
        }
    }
}

// ============================================================
// –ó–ê–ì–†–£–ó–ö–ê –ù–ê–°–¢–†–û–ï–ö
// ============================================================

async function loadSettings() {
    showLoading();
    const result = await apiRequest({ action: 'getSettings', password: currentUser.password });
    hideLoading();
    
    if (result.success) {
        settings = {
            units: result.units || [],
            categories: result.categories || [],
            departments: result.departments || []
        };
        currentUser.employees = result.employees || currentUser.employees;
        currentUser.department = result.department || currentUser.department;
        populateSelects();
    } else {
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + (result.error || ''), 'error');
    }
}

function populateSelects() {
    // –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ
    const deptSelect = document.getElementById('orderDepartment');
    deptSelect.innerHTML = '';
    if (currentUser.role === 'admin') {
        deptSelect.disabled = false;
        settings.departments.forEach(dept => {
            deptSelect.innerHTML += `<option value="${dept}">${dept}</option>`;
        });
    } else {
        deptSelect.disabled = true;
        deptSelect.innerHTML = `<option value="${currentUser.department}">${currentUser.department}</option>`;
    }
    
    // –ö–∞—Ç–µ–≥–æ—Ä–∏—è
    const catSelect = document.getElementById('orderCategory');
    catSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>';
    settings.categories.forEach(cat => {
        catSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
    });
    
    // –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π
    const respSelect = document.getElementById('orderResponsible');
    respSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>';
    currentUser.employees.forEach(emp => {
        respSelect.innerHTML += `<option value="${emp}">${emp}</option>`;
    });
    
    // –°–æ–∑–¥–∞–ª –∑–∞—è–≤–∫—É
    const createdBySelect = document.getElementById('orderCreatedBy');
    createdBySelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>';
    currentUser.employees.forEach(emp => {
        createdBySelect.innerHTML += `<option value="${emp}">${emp}</option>`;
    });
    
    // –§–∏–ª—å—Ç—Ä –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏
    const filterDeptSelect = document.getElementById('filterDepartment');
    filterDeptSelect.innerHTML = '<option value="">–í—Å–µ</option>';
    if (currentUser.role === 'admin') {
        filterDeptSelect.disabled = false;
        settings.departments.forEach(dept => {
            filterDeptSelect.innerHTML += `<option value="${dept}">${dept}</option>`;
        });
    } else {
        filterDeptSelect.disabled = true;
    }
}

// ============================================================
// –ì–õ–ê–í–ù–´–ô –≠–ö–†–ê–ù
// ============================================================

function showMainScreen() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainScreen').style.display = 'block';
    document.getElementById('userDepartment').textContent = 
        currentUser.role === 'admin' ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : currentUser.department;
    document.getElementById('orderDate').value = formatDate(new Date());
    clearForm();
}

// ============================================================
// –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–û–ó–ò–¶–ò–Ø–ú–ò
// ============================================================

function addPositionRow(data = null) {
    const tbody = document.getElementById('positionsBody');
    const currentRows = tbody.querySelectorAll('tr').length;
    
    if (currentRows >= 15) {
        showToast('–ú–∞–∫—Å–∏–º—É–º 15 –ø–æ–∑–∏—Ü–∏–π', 'warning');
        return;
    }
    
    positionRowCount++;
    const rowNum = currentRows + 1;
    
    let unitsOptions = '<option value="">-</option>';
    settings.units.forEach(unit => {
        const selected = (data && data.unit === unit) ? 'selected' : '';
        unitsOptions += `<option value="${unit}" ${selected}>${unit}</option>`;
    });
    
    const tr = document.createElement('tr');
    tr.setAttribute('data-row-id', positionRowCount);
    tr.innerHTML = `
        <td class="col-num">${rowNum}</td>
        <td class="col-name"><input type="text" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ" value="${data ? data.name : ''}"></td>
        <td class="col-unit"><select>${unitsOptions}</select></td>
        <td class="col-qty"><input type="number" min="0" step="0.01" placeholder="0" value="${data ? data.quantity : ''}"></td>
        <td class="col-article"><input type="text" placeholder="–ê—Ä—Ç–∏–∫—É–ª" value="${data ? data.article : ''}"></td>
        <td class="col-note"><input type="text" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ" value="${data ? data.note : ''}"></td>
        <td class="col-action"><button class="delete-row-btn" onclick="deletePositionRow(this)">‚úï</button></td>
    `;
    tbody.appendChild(tr);
}

function deletePositionRow(btn) {
    const tbody = document.getElementById('positionsBody');
    if (tbody.querySelectorAll('tr').length <= 1) {
        showToast('–î–æ–ª–∂–Ω–∞ –æ—Å—Ç–∞—Ç—å—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –ø–æ–∑–∏—Ü–∏—è', 'warning');
        return;
    }
    btn.closest('tr').remove();
    renumberPositions();
}

function renumberPositions() {
    const rows = document.getElementById('positionsBody').querySelectorAll('tr');
    rows.forEach((row, index) => {
        row.querySelector('.col-num').textContent = index + 1;
    });
}

function getPositionsData() {
    const rows = document.getElementById('positionsBody').querySelectorAll('tr');
    const positions = [];
    rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        const select = row.querySelector('select');
        const name = inputs[0].value.trim();
        const quantity = inputs[1].value.trim();
        if (name || quantity) {
            positions.push({
                name: name,
                unit: select.value,
                quantity: quantity,
                article: inputs[2].value.trim(),
                note: inputs[3].value.trim()
            });
        }
    });
    return positions;
}

function clearForm() {
    document.getElementById('orderNumber').value = '';
    document.getElementById('orderDate').value = formatDate(new Date());
    document.getElementById('orderObject').value = '';
    document.getElementById('orderCategory').value = '';
    document.getElementById('orderResponsible').value = '';
    document.getElementById('orderCreatedBy').value = '';
    document.getElementById('positionsBody').innerHTML = '';
    positionRowCount = 0;
    addPositionRow();
}

// ============================================================
// –°–û–•–†–ê–ù–ï–ù–ò–ï –ó–ê–Ø–í–ö–ò
// ============================================================

async function saveOrder() {
    const department = document.getElementById('orderDepartment').value;
    const object = document.getElementById('orderObject').value.trim();
    const category = document.getElementById('orderCategory').value;
    const responsible = document.getElementById('orderResponsible').value;
    const createdBy = document.getElementById('orderCreatedBy').value;
    
    if (!object) { showToast('–£–∫–∞–∂–∏—Ç–µ –æ–±—ä–µ–∫—Ç', 'error'); return; }
    if (!category) { showToast('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é', 'error'); return; }
    if (!responsible) { showToast('–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ', 'error'); return; }
    if (!createdBy) { showToast('–£–∫–∞–∂–∏—Ç–µ, –∫—Ç–æ —Å–æ–∑–¥–∞–ª –∑–∞—è–≤–∫—É', 'error'); return; }
    
    const positions = getPositionsData();
    if (positions.length === 0) { showToast('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–æ–∑–∏—Ü–∏—é', 'error'); return; }
    
    for (let i = 0; i < positions.length; i++) {
        if (!positions[i].name) { showToast(`–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≤ –ø–æ–∑–∏—Ü–∏–∏ ${i + 1}`, 'error'); return; }
        if (!positions[i].unit) { showToast(`–í—ã–±–µ—Ä–∏—Ç–µ –µ–¥. –∏–∑–º–µ—Ä–µ–Ω–∏—è –≤ –ø–æ–∑–∏—Ü–∏–∏ ${i + 1}`, 'error'); return; }
        if (!positions[i].quantity || positions[i].quantity <= 0) { showToast(`–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –ø–æ–∑–∏—Ü–∏–∏ ${i + 1}`, 'error'); return; }
    }
    
    showLoading();
    
    const result = await apiRequest({
        action: 'saveOrder',
        password: currentUser.password,
        department: department,
        object: object,
        category: category,
        responsible: responsible,
        createdBy: createdBy,
        positions: encodeURIComponent(JSON.stringify(positions))
    });
    
    hideLoading();
    
    if (result.success) {
        showToast(`–ó–∞—è–≤–∫–∞ ${result.orderNumber} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!`, 'success');
        clearForm();
    } else {
        showToast(result.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
    }
}

// ============================================================
// –ò–°–¢–û–†–ò–Ø –ó–ê–Ø–í–û–ö
// ============================================================

function openHistory() {
    document.getElementById('historyModal').classList.add('active');
    loadHistory();
}

function closeHistory() {
    document.getElementById('historyModal').classList.remove('active');
}

function clearFilters() {
    document.getElementById('filterDepartment').value = '';
    document.getElementById('filterDate').value = '';
    loadHistory();
}

async function loadHistory() {
    const filterDept = document.getElementById('filterDepartment').value;
    const filterDate = document.getElementById('filterDate').value;
    
    showLoading();
    
    let formattedDate = '';
    if (filterDate) {
        const d = new Date(filterDate);
        formattedDate = `${String(d.getDate()).padStart(2, '0')}.${String(d.getMonth() + 1).padStart(2, '0')}.${d.getFullYear()}`;
    }
    
    const result = await apiRequest({
        action: 'getHistory',
        password: currentUser.password,
        filterDept: filterDept,
        filterDate: formattedDate
    });
    
    hideLoading();
    
    const tbody = document.getElementById('historyBody');
    const emptyDiv = document.getElementById('historyEmpty');
    
    if (result.success && result.orders && result.orders.length > 0) {
        tbody.innerHTML = '';
        emptyDiv.style.display = 'none';
        
        result.orders.forEach(order => {
            let statusClass = 'pending', statusText = '–û–∂–∏–¥–∞–µ—Ç';
            if (order.completedPositions === order.totalPositions && order.totalPositions > 0) {
                statusClass = 'completed'; statusText = '–í—ã–ø–æ–ª–Ω–µ–Ω–æ';
            } else if (order.completedPositions > 0) {
                statusClass = 'partial'; statusText = `${order.completedPositions}/${order.totalPositions}`;
            }
            
            const tr = document.createElement('tr');
            tr.onclick = () => openOrderDetails(order.id);
            tr.innerHTML = `
                <td><strong>${order.number}</strong></td>
                <td>${order.date}</td>
                <td>${order.department}</td>
                <td>${order.object || '-'}</td>
                <td>${order.createdBy || '-'}</td>
                <td>${order.responsible}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            `;
            tbody.appendChild(tr);
        });
    } else {
        tbody.innerHTML = '';
        emptyDiv.style.display = 'block';
    }
}

// ============================================================
// –î–ï–¢–ê–õ–ò –ó–ê–Ø–í–ö–ò
// ============================================================

async function openOrderDetails(orderId) {
    currentOrderId = orderId;
    showLoading();
    
    const result = await apiRequest({
        action: 'getOrderDetails',
        orderId: orderId,
        password: currentUser.password
    });
    
    hideLoading();
    
    if (result.success) {
        const order = result.order;
        document.getElementById('detailsOrderNumber').textContent = order.number;
        document.getElementById('detailNumber').textContent = order.number;
        document.getElementById('detailDate').textContent = order.date;
        document.getElementById('detailDepartment').textContent = order.department;
        document.getElementById('detailObject').textContent = order.object || '-';
        document.getElementById('detailCategory').textContent = order.category;
        document.getElementById('detailResponsible').textContent = order.responsible;
        document.getElementById('detailCreatedBy').textContent = order.createdBy || '-';
        
        document.getElementById('deleteOrderBtn').style.display = 
            currentUser.role === 'admin' ? 'inline-flex' : 'none';
        
        const tbody = document.getElementById('detailsPositionsBody');
        tbody.innerHTML = '';
        
        result.positions.forEach(pos => {
            const statusClass = pos.status == 1 ? 'completed' : 'not-completed';
            const statusIcon = pos.status == 1 ? '‚úì' : '‚úï';
            const canChange = result.canChangeStatus && (currentUser.role === 'admin' || pos.status == 0);
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="col-num">${pos.position}</td>
                <td class="col-name">${pos.name}</td>
                <td class="col-unit">${pos.unit}</td>
                <td class="col-qty">${pos.quantity}</td>
                <td class="col-article">${pos.article || '-'}</td>
                <td class="col-note">${pos.note || '-'}</td>
                <td class="col-status">
                    <button class="status-btn ${statusClass}" 
                            onclick="toggleStatus(${pos.rowIndex}, ${pos.status}, '${orderId}')"
                            ${!canChange ? 'disabled' : ''}>
                        ${statusIcon}
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        document.getElementById('historyModal').classList.remove('active');
        document.getElementById('orderDetailsModal').classList.add('active');
    } else {
        showToast(result.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–∫–∏', 'error');
    }
}

function closeOrderDetails() {
    document.getElementById('orderDetailsModal').classList.remove('active');
    currentOrderId = null;
    openHistory();
}

// ============================================================
// –ò–ó–ú–ï–ù–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê
// ============================================================

async function toggleStatus(rowIndex, currentStatus, orderId) {
    const newStatus = currentStatus == 1 ? 0 : 1;
    
    if (currentUser.role !== 'admin' && currentStatus == 1) {
        showToast('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ', 'warning');
        return;
    }
    
    showLoading();
    
    const result = await apiRequest({
        action: 'updateStatus',
        password: currentUser.password,
        rowIndex: rowIndex,
        status: newStatus,
        orderId: orderId
    });
    
    hideLoading();
    
    if (result.success) {
        showToast(newStatus == 1 ? '–ü–æ–∑–∏—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞' : '–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ', 'success');
        openOrderDetails(orderId);
    } else {
        showToast(result.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞', 'error');
    }
}

// ============================================================
// –£–î–ê–õ–ï–ù–ò–ï –ó–ê–Ø–í–ö–ò
// ============================================================

async function deleteCurrentOrder() {
    if (!currentOrderId) return;
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?')) return;
    
    showLoading();
    const result = await apiRequest({
        action: 'deleteOrder',
        orderId: currentOrderId,
        password: currentUser.password
    });
    hideLoading();
    
    if (result.success) {
        showToast('–ó–∞—è–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
        closeOrderDetails();
    } else {
        showToast(result.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
    }
}

// ============================================================
// –ü–ï–ß–ê–¢–¨
// ============================================================

function printOrder() {
    const positions = getPositionsData();
    if (positions.length === 0) { showToast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–µ—á–∞—Ç–∏', 'warning'); return; }
    
    generatePrintContent({
        number: document.getElementById('orderNumber').value || '–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞',
        date: document.getElementById('orderDate').value,
        department: document.getElementById('orderDepartment').value,
        object: document.getElementById('orderObject').value,
        category: document.getElementById('orderCategory').value,
        responsible: document.getElementById('orderResponsible').value,
        createdBy: document.getElementById('orderCreatedBy').value,
        positions: positions
    });
}

function printOrderDetails() {
    const positions = [];
    document.getElementById('detailsPositionsBody').querySelectorAll('tr').forEach(row => {
        const cells = row.querySelectorAll('td');
        positions.push({
            name: cells[1].textContent,
            unit: cells[2].textContent,
            quantity: cells[3].textContent,
            article: cells[4].textContent,
            note: cells[5].textContent
        });
    });
    
    generatePrintContent({
        number: document.getElementById('detailNumber').textContent,
        date: document.getElementById('detailDate').textContent,
        department: document.getElementById('detailDepartment').textContent,
        object: document.getElementById('detailObject').textContent,
        category: document.getElementById('detailCategory').textContent,
        responsible: document.getElementById('detailResponsible').textContent,
        createdBy: document.getElementById('detailCreatedBy').textContent,
        positions: positions
    });
}

function generatePrintContent(data) {
    let positionsHTML = '';
    data.positions.forEach((pos, index) => {
        positionsHTML += `
            <tr>
                <td style="border:1px solid #000;padding:8px;text-align:center;">${index + 1}</td>
                <td style="border:1px solid #000;padding:8px;">${pos.name}</td>
                <td style="border:1px solid #000;padding:8px;text-align:center;">${pos.unit}</td>
                <td style="border:1px solid #000;padding:8px;text-align:center;">${pos.quantity}</td>
                <td style="border:1px solid #000;padding:8px;text-align:center;">${pos.article || '-'}</td>
                <td style="border:1px solid #000;padding:8px;">${pos.note || '-'}</td>
            </tr>
        `;
    });
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>–ó–∞—è–≤–∫–∞ ${data.number}</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1 { text-align: center; font-size: 18px; margin-bottom: 20px; }
                .header-info { margin-bottom: 20px; }
                .header-info p { margin: 5px 0; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th { border: 1px solid #000; padding: 8px; background: #f0f0f0; font-size: 12px; }
            </style>
        </head>
        <body>
            <h1>–ó–ê–Ø–í–ö–ê –ù–ê –ú–ê–¢–ï–†–ò–ê–õ–´ ‚Ññ ${data.number}</h1>
            <div class="header-info">
                <p><strong>–î–∞—Ç–∞:</strong> ${data.date}</p>
                <p><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong> ${data.department}</p>
                <p><strong>–û–±—ä–µ–∫—Ç:</strong> ${data.object || '-'}</p>
                <p><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> ${data.category}</p>
                <p><strong>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong> ${data.responsible}</p>
                <p><strong>–°–æ–∑–¥–∞–ª –∑–∞—è–≤–∫—É:</strong> ${data.createdBy || '-'}</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th style="width:40px;">‚Ññ</th>
                        <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                        <th style="width:60px;">–ï–¥.–∏–∑–º.</th>
                        <th style="width:60px;">–ö–æ–ª-–≤–æ</th>
                        <th style="width:100px;">–ê—Ä—Ç–∏–∫—É–ª</th>
                        <th style="width:150px;">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
                    </tr>
                </thead>
                <tbody>${positionsHTML}</tbody>
            </table>
            <div style="margin-top:30px;">
                <p><strong>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong> _______________ / ${data.responsible} /</p>
                <p style="margin-top:20px;"><strong>–°–æ–∑–¥–∞–ª –∑–∞—è–≤–∫—É:</strong> _______________ / ${data.createdBy || ''} /</p>
            </div>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

// ============================================================
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
// ============================================================

document.getElementById('passwordInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') handleLogin();
});

window.onload = function() {
    checkSession();
};
</script>
</body>
</html>
